<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notable Positions</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <section id="navSection" class="nav-section">
        <div class="container">
            <div class="nav-content-div">
                <a href="index.html" class="logo-item">
                    <img src="Assets/logo-notable-positions.svg" alt="Notable positions Logo">
                </a>

                <div class="nav-menu-div">
                    <a href="index.html" class="nav-menu-item">All AMC</a>
                    <a href="your-fundlist.html" class="nav-menu-item active">Your Fundlist</a>
                    <a href="profile.html" class="nav-menu-item">Profile</a>
                </div>
            </div>
        </div>
    </section>

    <section id="fundListSection" class="main-section">
        <div class="container">
            <div class="main-content-div">
                <div class="h1-body-div">
                    <h1>Your Fundlist</h1>
                    <p class="description">Track multiple AMCs in one place</p>
                </div>

                <!-- tabs -->
                <div id="amcTabs" class="tabs-div">
                    <div class="tab-item active" onclick="showTab('perMonthAnalysis')">Per Month Analysis</div>
                    <div class="tab-item" onclick="showTab('monthOnMonthAnalysis')">Month on Month Analysis</div>
                </div>

                <!-- per month analysis tab content -->
                <div id="perMonthAnalysis" class="list-div">
                    <div class="table-div">
                        <div class="table-menu">
                            <div class="seg-btn">
                                <input type="radio" id="pcaQuantity" name="pcaDataType" value="Quantity" checked>
                                <label for="pcaQuantity" class="radio-label">Quantity</label>
                                <input type="radio" id="pcaMarketValue" name="pcaDataType" value="Market Value">
                                <label for="pcaMarketValue" class="radio-label">Market Value</label>
                                <input type="radio" id="pcaNavPercentage" name="pcaDataType" value="% to Nav">
                                <label for="pcaNavPercentage" class="radio-label">% to Nav</label>
                            </div>

                            <div class="suffix-menu">
                                <!-- month select dropdown -->
                                <div class="input-dropdown-box">
                                    <select id="monthSelect" class="dropdown-menu"></select>

                                    <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                        fill="currentColor">
                                        <path
                                            d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z">
                                        </path>
                                    </svg>
                                </div>

                                <!-- amc select dropdown -->
                                <div class="input-dropdown-box">
                                    <button id="pmaAMCButton" class="dropdown-menu"
                                        onclick="togglePMAAMCDropdown(event)">
                                        All AMC
                                        <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path
                                                d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z">
                                            </path>
                                        </svg>
                                    </button>
                                    <div id="pmaAMCDropdown" class="dropdown-content" style="display: none;">
                                        <label class="dropdown-item">
                                            <input type="checkbox" value="all" checked
                                                onchange="handleAllPMAAMCChange(this)">
                                            <span>All AMC</span>
                                        </label>
                                        <div id="pmaAMCOptions">
                                            <!-- AMC options will be populated here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- category select dropdown -->
                                <div class="input-dropdown-box">
                                    <button id="pmaCategoryButton" class="dropdown-menu"
                                        onclick="togglePMACategoryDropdown(event)">
                                        All Categories
                                        <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path
                                                d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z">
                                            </path>
                                        </svg>
                                    </button>
                                    <div id="pmaCategoryDropdown" class="dropdown-content" style="display: none;">
                                        <label class="dropdown-item">
                                            <input type="checkbox" value="all" checked
                                                onchange="handleAllPMACategoryChange(this)">
                                            <span>All Categories</span>
                                        </label>
                                        <div id="pmaCategoryOptions">
                                            <!-- Category options will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- render per month analysis table -->
                        <table id="pmaTable" class="table-comp">
                            <thead>
                                <tr>

                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- month on month analysis tab content -->
                <div id="monthOnMonthAnalysis" class="list-div">
                    <div class="table-div">
                        <div class="table-menu">
                            <div class="seg-btn">
                                <input type="radio" id="momQuantity" name="momDataType" value="Quantity" checked>
                                <label for="momQuantity" class="radio-label">Quantity</label>
                                <input type="radio" id="momMarketValue" name="momDataType" value="Market Value">
                                <label for="momMarketValue" class="radio-label">Market Value</label>
                                <input type="radio" id="momNavPercentage" name="momDataType" value="% to Nav">
                                <label for="momNavPercentage" class="radio-label">% to Nav</label>
                            </div>

                            <div class="suffix-menu">
                                <!-- amc select dropdown -->
                                <div class="input-dropdown-box">
                                    <button id="momAMCButton" class="dropdown-menu" onclick="toggleAMCDropdown(event)">
                                        All AMC
                                        <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path
                                                d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z">
                                            </path>
                                        </svg>
                                    </button>
                                    <div id="momAMCDropdown" class="dropdown-content" style="display: none;">
                                        <label class="dropdown-item">
                                            <input type="checkbox" value="all" checked
                                                onchange="handleAllAMCChange(this)">
                                            <span>All AMC</span>
                                        </label>
                                        <div id="momAMCOptions">
                                            <!-- AMC options will be populated here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- category select dropdown -->
                                <div class="input-dropdown-box">
                                    <button id="momCategoryButton" class="dropdown-menu"
                                        onclick="toggleMOMCategoryDropdown(event)">
                                        All Categories
                                        <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path
                                                d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z">
                                            </path>
                                        </svg>
                                    </button>
                                    <div id="momCategoryDropdown" class="dropdown-content" style="display: none;">
                                        <label class="dropdown-item">
                                            <input type="checkbox" value="all" checked
                                                onchange="handleAllMOMCategoryChange(this)">
                                            <span>All Categories</span>
                                        </label>
                                        <div id="momCategoryOptions">
                                            <!-- Category options will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- render month on month analysis table -->
                        <table id="momTable" class="table-comp">
                            <thead>
                                <tr>

                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="footerSection" class="footer-section">
        <div class="container">
            <div class="footer-content-div">
                <div class="footer-left-div">
                    <p class="footer-text">© 2024</p>
                </div>

                <div class="footer-links-div">
                    <a href="index.html" class="footer-link-item">All AMC</a>
                    <a href="your-fundlist.html" class="footer-link-item">Your Fundlist</a>
                    <a href="profile.html" class="footer-link-item">Profile</a>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Supabase database config
        const SUPABASE_URL = 'https://ymimxlqqygezpkzqcejp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltaW14bHFxeWdlenBrenFjZWpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE1OTA3OTAsImV4cCI6MjA0NzE2Njc5MH0.h_l5abS25u4OqHt4LDqC-Hl3XQtwQ6pW7SgnoBEaTRU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global variables to store data
        let masterData, isinData, monthlyData;
        let months = [];
        let categoryData = []; // Stores unique categories

        // fetches and processes data from supabase database
        async function fetchData() {
            // Show loading indicator while fetching data
            showLoading(true);
            try {
                // Fetch master table data
                const { data: master, error: masterError } = await supabase
                    .from('master')
                    .select('*');
                if (masterError) throw masterError;

                // Initialize array for ISIN data
                let allIsinData = [];
                let page = 0;
                const pageSize = 1000; // Number of records per page

                // Fetch ISIN data in batches to handle large datasets
                while (true) {

                    // Fetch a batch of ISIN records
                    const { data: isin, error: isinError } = await supabase
                        .from('isin')
                        .select('*')
                        .range(page * pageSize, (page + 1) * pageSize - 1);

                    if (isinError) throw isinError;

                    // Append current batch to allIsinData array
                    allIsinData = allIsinData.concat(isin);

                    // Break the loop if we received fewer records than pageSize indicating we've reached the end
                    if (isin.length < pageSize) break;
                    page++;
                }

                // Store fetched data in global variables
                masterData = master;
                isinData = allIsinData;

                // Extract unique categories and populate dropdowns
                categoryData = [...new Set(masterData.map(fund => fund['Category']))];

                // Extract unique AMC values from master data
                const amcs = [...new Set(masterData.map(fund => fund['AMC']))];

                // Get reference to PMA AMC options container
                const pmaAMCOptions = document.getElementById('pmaAMCOptions');

                // If container exists, populate it with checkboxes for each AMC
                if (pmaAMCOptions) {
                    pmaAMCOptions.innerHTML = amcs.map(amc => `
                        <label class="dropdown-item">
                        <input type="checkbox" value="${amc}" checked onchange="handlePMAAMCOptionChange()">
                        <span>${amc}</span>
                        </label>
                    `).join('');
                }

                // Populate PMA category options
                const pmaCategoryOptions = document.getElementById('pmaCategoryOptions');
                if (pmaCategoryOptions) {
                    pmaCategoryOptions.innerHTML = categoryData.map(category => `
                        <label class="dropdown-item">
                        <input type="checkbox" value="${category}" checked onchange="handlePMACategoryOptionChange()">
                        <span>${category}</span>
                        </label>
                    `).join('');
                }

                // Populate MOM category options
                const momCategoryOptions = document.getElementById('momCategoryOptions');
                if (momCategoryOptions) {
                    momCategoryOptions.innerHTML = categoryData.map(category => `
                        <label class="dropdown-item">
                        <input type="checkbox" value="${category}" checked onchange="handleMOMCategoryOptionChange()">
                        <span>${category}</span>
                        </label>
                    `).join('');
                }

                // Fetch monthly data and update UI
                await fetchMonthlyData();
                renderPerMonthAnalysis();
            } catch (error) {

                // Handle any errors that occur during data fetching
                console.error('Error fetching data:', error);
                alert('An error occurred while fetching data. Please try again later.');
            } finally {

                // Hide loading indicator regardless of success or failure
                showLoading(false);
            }
        }

        // Fetches monthly data for per month analysis
        async function fetchMonthlyData() {

            // Initialize empty object to store monthly data for all funds
            monthlyData = {};

            // Iterate through each fund in masterData
            for (const fund of masterData) {

                // Fetch data from fund-specific database table
                const { data, error } = await supabase
                    .from(fund['Database Table'])
                    .select('*');

                // Handle any errors during data fetch
                if (error) {
                    console.error(`Error fetching data for ${fund['Fund Name']}:`, error);
                    continue; // Skip to next fund if there's an error
                }

                // Store fund's monthly data in global monthlyData object
                monthlyData[fund['Fund Name']] = data;

                // Extract unique months from the data
                months = [...new Set([...months, ...data.map(d => d['Month'])])];
            }

            // Sort months chronologically
            months.sort((a, b) => new Date(a) - new Date(b));

            // Update the month dropdown in the UI with new data
            updateMonthDropdown();
        }

        // Toggle per month analysis category dropdowns
        function togglePMACategoryDropdown(event) {
            event.preventDefault();
            const dropdown = document.getElementById('pmaCategoryDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Toggle month on month analysis category dropdowns
        function toggleMOMCategoryDropdown(event) {
            event.preventDefault();
            const dropdown = document.getElementById('momCategoryDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Fetches and processes month-on-month data for month-on-month analysis
        async function fetchMonthOnMonthData() {
            try {
                // Step 1: Fetch master data from Supabase
                const { data: masterData, error: masterError } = await supabase
                    .from('master')
                    .select('*');

                // Handle any errors in master data fetch
                if (masterError) {
                    console.error('Error fetching master data:', masterError);
                    throw masterError;
                }

                // Step 2: Fetch monthly data for each fund
                let allMonthlyData = [];
                for (const fund of masterData) {
                    const tableName = fund['Database Table'];
                    console.log(`Fetching monthly data for ${fund['Fund Name']} from table ${tableName}...`);

                    // Fetch monthly data from fund-specific table
                    const { data: monthlyData, error: monthlyError } = await supabase
                        .from(tableName)
                        .select('*');

                    // Handle any errors in monthly data fetch
                    if (monthlyError) {
                        console.error(`Error fetching monthly data for ${fund['Fund Name']}:`, monthlyError);
                        throw monthlyError;
                    }

                    // Add fund name to each monthly entry for identification
                    const monthlyDataWithFund = monthlyData.map(entry => ({ ...entry, 'Fund Name': fund['Fund Name'] }));
                    allMonthlyData = allMonthlyData.concat(monthlyDataWithFund);
                }

                // Step 3: Process AMC options for UI
                // Extract unique AMCs from master data
                const amcs = [...new Set(masterData.map(fund => fund['AMC']))]; // per month analysis amc
                const momAMCOptions = document.getElementById('momAMCOptions'); // month on month analysis amc

                // Populate AMC dropdown options if element exists
                if (momAMCOptions) {
                    momAMCOptions.innerHTML = amcs.map(amc => `
                        <label class="dropdown-item">
                            <input type="checkbox" value="${amc}" checked onchange="handleAMCOptionChange()">
                            <span>${amc}</span>
                        </label>
                    `).join('');
                }

                // Sort months in ascending order, starting from August 24
                const months = [...new Set(allMonthlyData.map(item => item['Month']))].sort((a, b) => {
                    const dateA = new Date(a);
                    const dateB = new Date(b);
                    if (dateA.getFullYear() === dateB.getFullYear()) {
                        return dateA.getMonth() - dateB.getMonth();
                    }
                    return dateA.getFullYear() - dateB.getFullYear();
                });

                // Filter months to start from August 24
                const startMonth = months.find(month => {
                    const date = new Date(month);
                    return date.getMonth() === 7 && date.getFullYear() === 2024;
                });
                const filteredMonths = months.slice(months.indexOf(startMonth));

                renderMonthOnMonthTable(masterData, allMonthlyData, amcs, filteredMonths);

                // Update global variables for use in other functions
                window.masterData = masterData;
                window.allMonthlyData = allMonthlyData;
                window.months = filteredMonths;

                // Initialize the dropdown text
                updateAMCButtonText();

            } catch (error) {
                console.error('Error in fetchMonthOnMonthData:', error);
                document.getElementById('monthOnMonthAnalysis').innerHTML = '<p>Error loading month on month data. Please check the console for more details.</p>';
            }
        }

        function updateMonthDropdown() {
            const monthSelect = document.getElementById('monthSelect');
            monthSelect.innerHTML = '<option value="">Select months to compare</option>';
            for (let i = 0; i < months.length - 1; i++) {
                monthSelect.add(new Option(`${months[i]} - ${months[i + 1]}`, i));
            }
            // Select the latest month by default (last option)
            monthSelect.selectedIndex = monthSelect.options.length - 1;
            monthSelect.addEventListener('change', renderPerMonthAnalysis);

            // Trigger renderPerMonthAnalysis to load the table
            renderPerMonthAnalysis();
        }

        function getStockName(isinCode) {
            const stock = isinData.find(s => s['ISIN Code'] === isinCode);
            return stock ? stock['Stock Name'] : isinCode;
        }

        function getStockSymbol(isinCode) {
            const stock = isinData.find(s => s['ISIN Code'] === isinCode);
            return stock ? stock['Symbol'] : '';
        }

        function getSelectedAMCs() {
            return Array.from(document.getElementById('momAMCSelect').selectedOptions).map(option => option.value);
        }

        // Render per month analysis table
        function renderPerMonthAnalysis() {
            // required dom elements
            const monthSelect = document.getElementById('monthSelect');
            const pmaTable = document.getElementById('pmaTable');

            // validate required elements exist
            if (!monthSelect || !pmaTable) {
                console.error('Required elements for renderPerMonthAnalysis not found.');
                return;
            }

            // Get selected month index and validate
            const monthIndex = parseInt(document.getElementById('monthSelect').value);
            if (isNaN(monthIndex)) return;

            // Get selected data type (Quantity/Market Value/% to Nav)
            const dataType = document.querySelector('input[name="pcaDataType"]:checked').value;

            // Get table elements
            const table = document.getElementById('pmaTable');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');

            // Set up table header with sort functionality
            thead.innerHTML = `
                <th onclick="sortTable('pmaTable', 0)" class="head-main">Stock Name</th>
                <th onclick="sortTable('pmaTable', 1)" class="head-list">Consolidated Change</th>
            `;

            // Get selected AMCs and add columns for each
            const selectedAMCs = getSelectedPMAAMCs();
            selectedAMCs.forEach((amc, index) => {
                thead.innerHTML += `<th onclick="sortTable('pmaTable', ${index + 2})" class="head-list">${amc}</th>`;
            });

            // Clear existing table body
            tbody.innerHTML = '';

            // Get selected categories
            const selectedCategories = getSelectedPMACategories();

            // Filter masterData based on selected categories
            const filteredMasterData = masterData.filter(fund =>
                selectedCategories.includes('all') || selectedCategories.includes(fund['Category'])
            );

            // Get unique list of stocks from filtered monthly data
            const stocks = [...new Set(filteredMasterData.flatMap(fund =>
                monthlyData[fund['Fund Name']].map(d => d['ISIN Code'])
            ))];

            // Iterate through each stock to create table rows
            stocks.forEach(stock => {
                const row = tbody.insertRow();
                const stockNameCell = row.insertCell();

                // Add stock name and symbol cell
                stockNameCell.innerHTML = `${getStockName(stock)}<br><span class="symbol">${getStockSymbol(stock)}</span>`;
                stockNameCell.className = 'sticky-cell';

                // Initialize consolidated change tracking
                let consolidatedChange = 0;
                const consolidatedCell = row.insertCell();

                // Process each selected AMC
                selectedAMCs.forEach((amc, index) => {
                    // Get funds for current AMC that match the selected categories
                    const amcFunds = filteredMasterData.filter(fund => fund['AMC'] === amc);
                    let month0Value = 0, month1Value = 0;

                    // Calculate total values across all funds for this AMC
                    amcFunds.forEach(fund => {
                        // Get data for consecutive months
                        const month0Data = monthlyData[fund['Fund Name']].find(d => d['ISIN Code'] === stock && d['Month'] === months[monthIndex]);
                        const month1Data = monthlyData[fund['Fund Name']].find(d => d['ISIN Code'] === stock && d['Month'] === months[monthIndex + 1]);

                        // If data exists for both months, calculate values based on selected data type
                        if (month0Data && month1Data) {
                            if (dataType === 'Quantity') {
                                month0Value += parseFloat(month0Data['Quantity']) || 0;
                                month1Value += parseFloat(month1Data['Quantity']) || 0;
                            } else if (dataType === 'Market Value') {
                                month0Value += parseFloat(month0Data['Market Value']) || 0;
                                month1Value += parseFloat(month1Data['Market Value']) || 0;
                            } else if (dataType === '% to Nav') {
                                month0Value += parseFloat(month0Data['% to Nav']) || 0;
                                month1Value += parseFloat(month1Data['% to Nav']) || 0;
                            }
                        }
                    });

                    // Calculate and display change for this AMC
                    const change = month1Value - month0Value;
                    consolidatedChange += change;
                    row.insertCell().textContent = formatIndianNumber(change.toFixed(2));
                });

                // Display consolidated change for all AMCs
                consolidatedCell.textContent = formatIndianNumber(consolidatedChange.toFixed(2));
            });
        }

        function renderMonthOnMonthTable(masterData, monthlyData, selectedAMCs, months) {
            const table = document.getElementById('momTable');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');
            const dataType = document.querySelector('input[name="momDataType"]:checked').value;

            // Update table header
            thead.innerHTML = '<th onclick="sortTable(\'momTable\', 0)" class="head-main">Stock Name</th>';
            months.forEach((month, index) => {
                const date = new Date(month);
                const monthName = date.toLocaleString('default', { month: 'long' });
                const year = date.getFullYear().toString().slice(-2);
                thead.innerHTML += `<th onclick="sortTable('momTable', ${index + 1})" class="head-list">${monthName} ${year} Change</th>`;
            });

            // Get selected categories
            const selectedCategories = getSelectedMOMCategories();

            // Filter masterData based on selected categories
            const filteredMasterData = masterData.filter(fund =>
                selectedCategories.includes('all') || selectedCategories.includes(fund['Category'])
            );

            // Get all unique stocks from filtered data
            const stocks = [...new Set(monthlyData.filter(item =>
                filteredMasterData.some(fund => fund['Fund Name'] === item['Fund Name'])
            ).map(item => item['ISIN Code']))];

            // Prepare table body data
            const tableData = stocks.map(stock => {
                const row = [getStockName(stock)];
                months.forEach((month, monthIndex) => {
                    if (monthIndex === 0) {
                        row.push('-'); // No change for the first month
                        return;
                    }

                    let consolidatedChange = 0;
                    selectedAMCs.forEach(amc => {
                        const amcFunds = filteredMasterData.filter(fund => fund['AMC'] === amc);
                        amcFunds.forEach(fund => {
                            const prevMonthData = monthlyData.find(d => d['ISIN Code'] === stock && d['Month'] === months[monthIndex - 1] && d['Fund Name'] === fund['Fund Name']);
                            const currentMonthData = monthlyData.find(d => d['ISIN Code'] === stock && d['Month'] === month && d['Fund Name'] === fund['Fund Name']);

                            if (prevMonthData && currentMonthData) {
                                let prevValue = 0, currentValue = 0;
                                if (dataType === 'Quantity') {
                                    prevValue = parseFloat(prevMonthData['Quantity']) || 0;
                                    currentValue = parseFloat(currentMonthData['Quantity']) || 0;
                                } else if (dataType === 'Market Value') {
                                    prevValue = parseFloat(prevMonthData['Market Value']) || 0;
                                    currentValue = parseFloat(currentMonthData['Market Value']) || 0;
                                } else if (dataType === '% to Nav') {
                                    prevValue = parseFloat(prevMonthData['% to Nav']) || 0;
                                    currentValue = parseFloat(currentMonthData['% to Nav']) || 0;
                                }
                                consolidatedChange += currentValue - prevValue;
                            }
                        });
                    });
                    row.push(formatIndianNumber(consolidatedChange.toFixed(2)));
                });
                return row;
            });

            // Render table body
            tbody.innerHTML = tableData.map(row => `
                <tr>
                    ${row.map((cell, index) => `
                        <td ${index === 0 ? 'class="sticky-cell"' : ''}>${cell}</td>
                    `).join('')}
                </tr>
            `).join('');
        }

        function sortTable(tableId, n, sortType = 'value') {
            const table = document.getElementById(tableId);
            let rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            switching = true;
            dir = "asc";
            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[n];
                    y = rows[i + 1].getElementsByTagName("TD")[n];

                    let xValue, yValue;
                    if (n === 0) { // Stock Name column
                        xValue = x.textContent.toLowerCase();
                        yValue = y.textContent.toLowerCase();
                    } else if (sortType === 'change' && x.querySelector('span[data-change]')) {
                        xValue = parseFloat(x.querySelector('span[data-change]').getAttribute('data-change'));
                        yValue = parseFloat(y.querySelector('span[data-change]').getAttribute('data-change'));
                    } else {
                        xValue = parseFloat(x.textContent.replace(/,/g, ''));
                        yValue = parseFloat(y.textContent.replace(/,/g, ''));
                    }

                    if (dir == "asc") {
                        if ((typeof xValue === 'string' && xValue > yValue) ||
                            (typeof xValue === 'number' && xValue > yValue)) {
                            shouldSwitch = true;
                            break;
                        }
                    } else if (dir == "desc") {
                        if ((typeof xValue === 'string' && xValue < yValue) ||
                            (typeof xValue === 'number' && xValue < yValue)) {
                            shouldSwitch = true;
                            break;
                        }
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                    switchcount++;
                } else {
                    if (switchcount == 0 && dir == "asc") {
                        dir = "desc";
                        switching = true;
                    }
                }
            }
        }

        function showLoading(show) {
            document.getElementById('loading')
        }

        function togglePMAAMCDropdown(event) {
            event.preventDefault();
            const dropdown = document.getElementById('pmaAMCDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        function toggleAMCDropdown(event) {
            event.preventDefault();
            const dropdown = document.getElementById('momAMCDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        function handleAllPMAAMCChange(checkbox) {
            const options = document.querySelectorAll('#pmaAMCOptions input[type="checkbox"]');
            options.forEach(option => {
                option.checked = checkbox.checked;
            });
            updatePMAAMCButtonText();
            renderPerMonthAnalysis();
        }

        function handleAllAMCChange(checkbox) {
            const options = document.querySelectorAll('#momAMCOptions input[type="checkbox"]');
            options.forEach(option => {
                option.checked = checkbox.checked;
            });
            updateAMCButtonText();
            updateTable();
        }

        // Add this function to handle "All Categories" checkbox for PMA
        function handleAllPMACategoryChange(checkbox) {
            const options = document.querySelectorAll('#pmaCategoryOptions input[type="checkbox"]');
            options.forEach(option => {
                option.checked = checkbox.checked;
            });
            updatePMACategoryButtonText();
            renderPerMonthAnalysis();
        }

        // Add this function to handle "All Categories" checkbox for MOM
        function handleAllMOMCategoryChange(checkbox) {
            const options = document.querySelectorAll('#momCategoryOptions input[type="checkbox"]');
            options.forEach(option => {
                option.checked = checkbox.checked;
            });
            updateMOMCategoryButtonText();
            updateTable();
        }

        function handlePMACategoryOptionChange() {
            const allCheckbox = document.querySelector('#pmaCategoryDropdown input[value="all"]');
            const options = document.querySelectorAll('#pmaCategoryOptions input[type="checkbox"]');
            const allChecked = Array.from(options).every(option => option.checked);
            allCheckbox.checked = allChecked;

            const selectedCategories = getSelectedPMACategories();
            const button = document.getElementById('pmaCategoryButton');

            if (selectedCategories.length === 0 || (selectedCategories.length === 1 && selectedCategories[0] === 'all')) {
                button.textContent = 'All Categories';
            } else {
                button.textContent = `${selectedCategories.length} Categories selected`;
            }

            // Add the dropdown icon back
            button.innerHTML = button.textContent + '<svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z"></path></svg>';

            // Call renderPerMonthAnalysis to update the table
            renderPerMonthAnalysis();
            updatePMACategoryButtonText();
        }

        function handleMOMCategoryOptionChange() {
            const allCheckbox = document.querySelector('#momCategoryDropdown input[value="all"]');
            const options = document.querySelectorAll('#momCategoryOptions input[type="checkbox"]');
            const allChecked = Array.from(options).every(option => option.checked);
            allCheckbox.checked = allChecked;
            updateMOMCategoryButtonText();
            updateTable();
        }

        function updateMOMCategoryButtonText() {
            const button = document.getElementById('momCategoryButton');
            const allCheckbox = document.querySelector('#momCategoryDropdown input[value="all"]');
            const selectedOptions = document.querySelectorAll('#momCategoryOptions input[type="checkbox"]:checked');

            if (allCheckbox.checked) {
                button.textContent = 'All Categories';
            } else if (selectedOptions.length === 0) {
                button.textContent = 'Select Categories';
            } else {
                button.textContent = `${selectedOptions.length} Categories selected`;
            }

            button.innerHTML = button.textContent + '<svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z"></path></svg>';
        }

        function updatePMACategoryButtonText() {
            const button = document.getElementById('pmaCategoryButton');
            const allCheckbox = document.querySelector('#pmaCategoryDropdown input[value="all"]');
            const selectedOptions = document.querySelectorAll('#pmaCategoryOptions input[type="checkbox"]:checked');

            if (allCheckbox.checked) {
                button.textContent = 'All Categories';
            } else if (selectedOptions.length === 0) {
                button.textContent = 'Select Categories';
            } else {
                button.textContent = `${selectedOptions.length} Categories selected`;
            }

            button.innerHTML = button.textContent + '<svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z"></path></svg>';
        }

        function handlePMAAMCOptionChange() {
            const allCheckbox = document.querySelector('#pmaAMCDropdown input[value="all"]');
            const options = document.querySelectorAll('#pmaAMCOptions input[type="checkbox"]');
            const allChecked = Array.from(options).every(option => option.checked);
            allCheckbox.checked = allChecked;
            updatePMAAMCButtonText();
            renderPerMonthAnalysis();
        }

        function handleAMCOptionChange() {
            const allCheckbox = document.querySelector('input[value="all"]');
            const options = document.querySelectorAll('#momAMCOptions input[type="checkbox"]');
            const allChecked = Array.from(options).every(option => option.checked);
            allCheckbox.checked = allChecked;
            updateAMCButtonText();
            updateTable(); // Call updateTable here
        }

        function updatePMAAMCButtonText() {
            const button = document.getElementById('pmaAMCButton');
            const selectedOptions = document.querySelectorAll('#pmaAMCOptions input[type="checkbox"]:checked');

            if (selectedOptions.length === 0) {
                button.textContent = 'Select AMC';
            } else if (document.querySelector('#pmaAMCDropdown input[value="all"]').checked) {
                button.textContent = 'All AMC';
            } else {
                button.textContent = `${selectedOptions.length} AMC selected`;
            }

            button.innerHTML = button.textContent + '<svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z"></path></svg>';
        }

        function updateAMCButtonText() {
            const button = document.getElementById('momAMCButton');
            const selectedOptions = document.querySelectorAll('#momAMCOptions input[type="checkbox"]:checked');

            if (selectedOptions.length === 0) {
                button.textContent = 'Select AMC';
            } else if (document.querySelector('input[value="all"]').checked) {
                button.textContent = 'All AMC';
            } else {
                button.textContent = `${selectedOptions.length} AMC selected`;
            }

            // Add the dropdown icon back
            button.innerHTML = button.textContent + '<svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z"></path></svg>';
        }

        function getSelectedPMAAMCs() {
            const options = document.querySelectorAll('#pmaAMCOptions input[type="checkbox"]:checked');
            return Array.from(options).map(option => option.value);
        }

        function getSelectedAMCs() {
            const options = document.querySelectorAll('#momAMCOptions input[type="checkbox"]:checked');
            return Array.from(options).map(option => option.value);
        }

        // Add these functions to get selected categories
        function getSelectedPMACategories() {
            const allCheckbox = document.querySelector('#pmaCategoryDropdown input[value="all"]');
            if (allCheckbox.checked) {
                return ['all'];
            }
            const options = document.querySelectorAll('#pmaCategoryOptions input[type="checkbox"]:checked');
            return Array.from(options).map(option => option.value);
        }

        function getSelectedMOMCategories() {
            const allCheckbox = document.querySelector('#momCategoryDropdown input[value="all"]');
            if (allCheckbox.checked) {
                return ['all'];
            }
            const options = document.querySelectorAll('#momCategoryOptions input[type="checkbox"]:checked');
            return Array.from(options).map(option => option.value);
        }

        function updateTable() {
            const selectedAMCs = getSelectedAMCs();
            renderMonthOnMonthTable(masterData, allMonthlyData, selectedAMCs, months);
        }

        function addEventListeners() {
            document.querySelectorAll('input[name="pmaDataType"]').forEach(radio => {
                radio.addEventListener('change', renderPerMonthAnalysis);
            });
            // New event listeners for momDataType
            document.querySelectorAll('input[name="momDataType"]').forEach(radio => {
                radio.addEventListener('change', updateTable);
            });
            document.addEventListener('DOMContentLoaded', () => {
                fetchMonthOnMonthData();
                updateMonthDropdown(); // This will now select the latest month and render the table
            });

            document.getElementById('pmaCategoryOptions').addEventListener('change', handlePMACategoryOptionChange);
        }

        function showTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.list-div').forEach(div => {
                div.style.display = 'none';
            });

            // Remove 'active' class from all tab items
            document.querySelectorAll('.tab-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show the selected tab content
            document.getElementById(tabId).style.display = 'block';

            // Add 'active' class to the clicked tab item
            document.querySelector(`.tab-item[onclick="showTab('${tabId}')"]`).classList.add('active');
        }
 
        // Formats numbers in Indian number system (with commas)
        function formatIndianNumber(number) {
            const parts = number.toString().split('.');
            parts[0] = parts[0].replace(/(\d)(?=(\d\d)+\d$)/g, "$1,");
            return parts.join('.');
        }

        // Add event listeners to tab items
        document.addEventListener('DOMContentLoaded', () => {
            const tabItems = document.querySelectorAll('.tab-item');
            tabItems.forEach(item => {
                item.addEventListener('click', (event) => {
                    const tabId = event.target.getAttribute('onclick').match(/'([^']+)'/)[1];
                    showTab(tabId);
                });
            });

            document.addEventListener('click', function (event) {
                const dropdown = document.getElementById('momAMCDropdown');
                const button = document.getElementById('momAMCButton');
                if (!button.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.style.display = 'none';
                }
            });

            document.addEventListener('click', function (event) {
                const dropdown = document.getElementById('pmaAMCDropdown');
                const button = document.getElementById('pmaAMCButton');
                if (!button.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.style.display = 'none';
                }
            });

            // Add event listener for MOM "All Categories" checkbox
            const allMOMCategoriesCheckbox = document.querySelector('#momCategoryDropdown input[value="all"]');
            allMOMCategoriesCheckbox.addEventListener('change', (event) => handleAllMOMCategoryChange(event.target));

            // Add event listener for MOM individual category checkboxes
            const momCategoryOptions = document.querySelectorAll('#momCategoryOptions input[type="checkbox"]');
            momCategoryOptions.forEach(option => {
                option.addEventListener('change', handleMOMCategoryOptionChange);
            });

            // Add event listener for "All Categories" checkbox
            const allCategoriesCheckbox = document.querySelector('#pmaCategoryDropdown input[value="all"]');
            allCategoriesCheckbox.addEventListener('change', (event) => handleAllPMACategoryChange(event.target));

            // Add event listener for individual category checkboxes
            const categoryOptions = document.querySelectorAll('#pmaCategoryOptions input[type="checkbox"]');
            categoryOptions.forEach(option => {
                option.addEventListener('change', handlePMACategoryOptionChange);
            });

            document.getElementById('pmaAMCOptions').addEventListener('change', handlePMAAMCOptionChange);

            // Add event listener for AMC option changes
            document.getElementById('momAMCOptions').addEventListener('change', handleAMCOptionChange);

            // Show the default tab (Per Month Analysis)
            showTab('perMonthAnalysis');
        });


        fetchData();
        addEventListeners();

        // Initial render
        renderPerMonthAnalysis();
    </script>
</body>

</html>