<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notable Positions | Consolidate Mutual fund portfolio tracker</title>
    <meta name="description" content="Discover Indiaâ€™s first platform to consolidate and track mutual fund portfolios. Gain unparalleled insights into where mutual funds are investing their money. Stay ahead with detailed allocation trends and optimize your financial strategy.">
    <meta name="keywords" content="India mutual fund tracker, consolidated portfolio platform, mutual fund investment insights, track mutual fund investments, fund allocation analysis India, mutual fund portfolio India, investment tracking tool, mutual fund trends, mutual fund analysis India">

    <link rel="icon" href="Assets/favicon.ico" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <section id="navSection" class="nav-section">
        <div class="container">
            <div class="nav-content-div">
                <a href="index.html" class="logo-item">
                    <img src="Assets/logo-notable-positions.svg" alt="Notable positions Logo">
                </a>

                <div class="nav-menu-div">
                    <a href="index.html" class="nav-menu-item">All AMC</a>
                    <a href="your-fundlist.html" class="nav-menu-item active">Your Fundlist</a>
                    <a href="profile.html" class="nav-menu-item">Profile</a>
                </div>
            </div>
        </div>
    </section>

    <section id="fundListSection" class="main-section">
        <div class="container">
            <div class="main-content-div">
                <div class="h1-body-div">
                    <h1>Your Fundlist</h1>
                    <p class="description">Track multiple AMCs in one place</p>
                </div>

                <!-- tabs -->
                <div id="amcTabs" class="tabs-div">
                    <div class="tab-item active" onclick="showTab('perMonthAnalysis')">Per Month Analysis</div>
                    <div class="tab-item" onclick="showTab('monthOnMonthAnalysis')">Month on Month Analysis</div>
                </div>

                <!-- per month analysis tab content -->
                <div id="perMonthAnalysis" class="list-div">
                    <div class="table-div">
                        <div class="table-menu">
                            <div class="seg-btn">
                                <input type="radio" id="pmaQuantity" name="pmaDataType" value="Quantity" checked>
                                <label for="pmaQuantity" class="radio-label">Quantity</label>
                                <input type="radio" id="pmaMarketValue" name="pmaDataType" value="Market Value">
                                <label for="pmaMarketValue" class="radio-label">Market Value</label>
                                <input type="radio" id="pmaNavPercentage" name="pmaDataType" value="% to Nav">
                                <label for="pmaNavPercentage" class="radio-label">% to Nav</label>
                            </div>

                            <div class="suffix-menu">
                                <!-- month select dropdown -->
                                <div class="input-dropdown-box">
                                    <select id="monthSelect" class="dropdown-menu"></select>

                                    <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                        fill="currentColor">
                                        <path
                                            d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z">
                                        </path>
                                    </svg>
                                </div>

                                <!-- amc select dropdown -->
                                <div class="input-dropdown-box">
                                    <button id="pmaAMCButton" class="dropdown-menu"
                                        onclick="togglePMAAMCDropdown(event)">
                                        All AMC
                                        <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path
                                                d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z">
                                            </path>
                                        </svg>
                                    </button>
                                    <div id="pmaAMCDropdown" class="dropdown-content" style="display: none;">
                                        <label class="dropdown-item">
                                            <input type="checkbox" value="all" checked
                                                onchange="handleAllPMAAMCChange(this)">
                                            <span>All AMC</span>
                                        </label>
                                        <div id="pmaAMCOptions">
                                            <!-- AMC options will be populated here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- category select dropdown -->
                                <div class="input-dropdown-box">
                                    <button id="pmaCategoryButton" class="dropdown-menu"
                                        onclick="togglePMACategoryDropdown(event)">
                                        All Categories
                                        <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path
                                                d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z">
                                            </path>
                                        </svg>
                                    </button>
                                    <div id="pmaCategoryDropdown" class="dropdown-content" style="display: none;">
                                        <label class="dropdown-item">
                                            <input type="checkbox" value="all" checked
                                                onchange="handleAllPMACategoryChange(this)">
                                            <span>All Categories</span>
                                        </label>
                                        <div id="pmaCategoryOptions">
                                            <!-- Category options will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- render per month analysis table -->
                        <table id="pmaTable" class="table-comp">
                            <thead>
                                <tr>

                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>

                        <div class="error-msg" id="pmaErrorMessage" style="display: none;">
                            <h2 id="pmaErrorTitle">No Categories Selected</h1>
                            <p class="description" id="pmaerrorDescription">Choose at least one category to load data</p>
                        </div>
                    </div>
                </div>

                <!-- month on month analysis tab content -->
                <div id="monthOnMonthAnalysis" class="list-div">
                    <div class="table-div">
                        <div class="table-menu">
                            <div class="seg-btn">
                                <input type="radio" id="momQuantity" name="momDataType" value="Quantity" checked>
                                <label for="momQuantity" class="radio-label">Quantity</label>
                                <input type="radio" id="momMarketValue" name="momDataType" value="Market Value">
                                <label for="momMarketValue" class="radio-label">Market Value</label>
                                <input type="radio" id="momNavPercentage" name="momDataType" value="% to Nav">
                                <label for="momNavPercentage" class="radio-label">% to Nav</label>
                            </div>

                            <div class="suffix-menu">
                                <!-- amc select dropdown -->
                                <div class="input-dropdown-box">
                                    <button id="momAMCButton" class="dropdown-menu" onclick="toggleAMCDropdown(event)">
                                        All AMC
                                        <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path
                                                d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z">
                                            </path>
                                        </svg>
                                    </button>
                                    <div id="momAMCDropdown" class="dropdown-content" style="display: none;">
                                        <label class="dropdown-item">
                                            <input type="checkbox" value="all" checked
                                                onchange="handleAllAMCChange(this)">
                                            <span>All AMC</span>
                                        </label>
                                        <div id="momAMCOptions">
                                            <!-- AMC options will be populated here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- category select dropdown -->
                                <div class="input-dropdown-box">
                                    <button id="momCategoryButton" class="dropdown-menu"
                                        onclick="toggleMOMCategoryDropdown(event)">
                                        All Categories
                                        <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path
                                                d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z">
                                            </path>
                                        </svg>
                                    </button>
                                    <div id="momCategoryDropdown" class="dropdown-content" style="display: none;">
                                        <label class="dropdown-item">
                                            <input type="checkbox" value="all" checked
                                                onchange="handleAllMOMCategoryChange(this)">
                                            <span>All Categories</span>
                                        </label>
                                        <div id="momCategoryOptions">
                                            <!-- Category options will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- render month on month analysis table -->
                        <table id="momTable" class="table-comp">
                            <thead>
                                <tr>

                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>

                        <div class="error-msg" id="momErrorMessage" style="display: none;">
                            <h2 id="momErrorTitle">No Categories Selected</h1>
                            <p class="description" id="momErrorDescription">Choose at least one category to load data</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="footerSection" class="footer-section">
        <div class="container">
            <div class="footer-content-div">
                <div class="footer-left-div">
                    <p class="footer-text">Â© 2024</p>
                </div>

                <div class="footer-links-div">
                    <a href="index.html" class="footer-link-item">All AMC</a>
                    <a href="your-fundlist.html" class="footer-link-item">Your Fundlist</a>
                    <a href="profile.html" class="footer-link-item">Profile</a>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Constants
const SUPABASE_URL = 'https://ymimxlqqygezpkzqcejp.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltaW14bHFxeWdlenBrenFjZWpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE1OTA3OTAsImV4cCI6MjA0NzE2Njc5MH0.h_l5abS25u4OqHt4LDqC-Hl3XQtwQ6pW7SgnoBEaTRU';

// Global variables
let masterData, isinData, monthlyData, months = [], categoryData = [];
let lastSelectedStocks = [];
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Utility functions
function formatIndianNumber(number) {
  const parts = number.toString().split('.');
  parts[0] = parts[0].replace(/(\d)(?=(\d\d)+\d$)/g, "$1,");
  return parts.join('.');
}

function getStockName(isinCode) {
  const stock = isinData.find(s => s['ISIN Code'] === isinCode);
  return stock ? stock['Stock Name'] : isinCode;
}

function getStockSymbol(isinCode) {
  const stock = isinData.find(s => s['ISIN Code'] === isinCode);
  return stock ? stock['Symbol'] : '';
}

// Data fetching functions
async function fetchData() {
  showLoading(true);
  try {
      await fetchMasterData();
      await fetchIsinData();
      await fetchMonthlyData();
      populateDropdowns();
      renderPerMonthAnalysis();
  } catch (error) {
      console.error('Error fetching data:', error);
      alert('An error occurred while fetching data. Please try again later.');
  } finally {
      showLoading(false);
  }
}

async function fetchMasterData() {
  const { data, error } = await supabase.from('master').select('*');
  if (error) throw error;
  masterData = data;
  categoryData = [...new Set(masterData.map(fund => fund['Category']))];
}

async function fetchIsinData() {
  let allIsinData = [];
  let page = 0;
  const pageSize = 1000;

  while (true) {
      const { data, error } = await supabase
          .from('isin')
          .select('*')
          .range(page * pageSize, (page + 1) * pageSize - 1);

      if (error) throw error;
      allIsinData = allIsinData.concat(data);
      if (data.length < pageSize) break;
      page++;
  }

  isinData = allIsinData;
}

async function fetchMonthlyData() {
  monthlyData = {};
  for (const fund of masterData) {
      const { data, error } = await supabase.from(fund['Database Table']).select('*');
      if (error) {
          console.error(`Error fetching data for ${fund['Fund Name']}:`, error);
          continue;
      }
      monthlyData[fund['Fund Name']] = data;
      months = [...new Set([...months, ...data.map(d => d['Month'])])];
  }
  months.sort((a, b) => new Date(a) - new Date(b));
  updateMonthDropdown();
}

async function fetchMonthOnMonthData() {
  try {
      const { data: masterData, error: masterError } = await supabase.from('master').select('*');
      if (masterError) throw masterError;

      let allMonthlyData = [];
      for (const fund of masterData) {
          const { data: monthlyData, error: monthlyError } = await supabase
              .from(fund['Database Table'])
              .select('*');

          if (monthlyError) throw monthlyError;

          const monthlyDataWithFund = monthlyData.map(entry => ({ ...entry, 'Fund Name': fund['Fund Name'] }));
          allMonthlyData = allMonthlyData.concat(monthlyDataWithFund);
      }

      const amcs = [...new Set(masterData.map(fund => fund['AMC']))];
      populateMOMDropdowns(amcs);

      const months = [...new Set(allMonthlyData.map(item => item['Month']))].sort((a, b) => {
          const dateA = new Date(a);
          const dateB = new Date(b);
          return dateA.getFullYear() === dateB.getFullYear() 
              ? dateA.getMonth() - dateB.getMonth()
              : dateA.getFullYear() - dateB.getFullYear();
      });

      const startMonth = months.find(month => {
          const date = new Date(month);
          return date.getMonth() === 7 && date.getFullYear() === 2024;
      });
      const filteredMonths = months.slice(months.indexOf(startMonth));

      renderMonthOnMonthTable(masterData, allMonthlyData, amcs, filteredMonths);

      window.masterData = masterData;
      window.allMonthlyData = allMonthlyData;
      window.months = filteredMonths;

      updateAMCButtonText();
  } catch (error) {
      console.error('Error in fetchMonthOnMonthData:', error);
      document.getElementById('monthOnMonthAnalysis').innerHTML = '<p>Error loading month on month data. Please check the console for more details.</p>';
  }
}

// UI update functions
function populateDropdowns() {
  populatePMADropdowns();
  populateMOMDropdowns();
}

function populatePMADropdowns() {
  const amcs = [...new Set(masterData.map(fund => fund['AMC']))];
  const pmaAMCOptions = document.getElementById('pmaAMCOptions');
  if (pmaAMCOptions) {
      pmaAMCOptions.innerHTML = amcs.map(amc => `
          <label class="dropdown-item">
              <input type="checkbox" value="${amc}" checked onchange="handlePMAAMCOptionChange()">
              <span>${amc}</span>
          </label>
      `).join('');
  }

  const pmaCategoryOptions = document.getElementById('pmaCategoryOptions');
  if (pmaCategoryOptions) {
      pmaCategoryOptions.innerHTML = categoryData.map(category => `
          <label class="dropdown-item">
              <input type="checkbox" value="${category}" checked onchange="handlePMACategoryOptionChange()">
              <span>${category}</span>
          </label>
      `).join('');
  }
}

function populateMOMDropdowns(amcs = []) {
  const momAMCOptions = document.getElementById('momAMCOptions');
  if (momAMCOptions) {
      momAMCOptions.innerHTML = (amcs.length > 0 ? amcs : [...new Set(masterData.map(fund => fund['AMC']))]).map(amc => `
          <label class="dropdown-item">
              <input type="checkbox" value="${amc}" checked onchange="handleAMCOptionChange()">
              <span>${amc}</span>
          </label>
      `).join('');
  }

  const momCategoryOptions = document.getElementById('momCategoryOptions');
  if (momCategoryOptions) {
      momCategoryOptions.innerHTML = categoryData.map(category => `
          <label class="dropdown-item">
              <input type="checkbox" value="${category}" checked onchange="handleMOMCategoryOptionChange()">
              <span>${category}</span>
          </label>
      `).join('');
  }
}

function updateMonthDropdown() {
  const monthSelect = document.getElementById('monthSelect');
  monthSelect.innerHTML = '<option value="">Select months to compare</option>';
  for (let i = 0; i < months.length - 1; i++) {
      monthSelect.add(new Option(`${months[i]} - ${months[i + 1]}`, i));
  }
  monthSelect.selectedIndex = monthSelect.options.length - 1;
  monthSelect.addEventListener('change', renderPerMonthAnalysis);
  renderPerMonthAnalysis();
}

function updatePMAAMCButtonText() {
  const button = document.getElementById('pmaAMCButton');
  const selectedOptions = document.querySelectorAll('#pmaAMCOptions input[type="checkbox"]:checked');

  if (selectedOptions.length === 0) {
      button.textContent = 'Select AMC';
  } else if (document.querySelector('#pmaAMCDropdown input[value="all"]').checked) {
      button.textContent = 'All AMC';
  } else {
      button.textContent = `${selectedOptions.length} AMC selected`;
  }

  button.innerHTML = button.textContent + '<svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z"></path></svg>';
}

function updateAMCButtonText() {
  const button = document.getElementById('momAMCButton');
  const selectedOptions = document.querySelectorAll('#momAMCOptions input[type="checkbox"]:checked');

  if (selectedOptions.length === 0) {
      button.textContent = 'Select AMC';
  } else if (document.querySelector('input[value="all"]').checked) {
      button.textContent = 'All AMC';
  } else {
      button.textContent = `${selectedOptions.length} AMC selected`;
  }

  button.innerHTML = button.textContent + '<svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z"></path></svg>';
}

function updatePMACategoryButtonText() {
  const button = document.getElementById('pmaCategoryButton');
  const allCheckbox = document.querySelector('#pmaCategoryDropdown input[value="all"]');
  const selectedOptions = document.querySelectorAll('#pmaCategoryOptions input[type="checkbox"]:checked');

  if (allCheckbox.checked) {
      button.textContent = 'All Categories';
  } else if (selectedOptions.length === 0) {
      button.textContent = 'Select Categories';
  } else {
      button.textContent = `${selectedOptions.length} Categories selected`;
  }

  button.innerHTML = button.textContent + '<svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z"></path></svg>';
}

function updateMOMCategoryButtonText() {
  const button = document.getElementById('momCategoryButton');
  const allCheckbox = document.querySelector('#momCategoryDropdown input[value="all"]');
  const selectedOptions = document.querySelectorAll('#momCategoryOptions input[type="checkbox"]:checked');

  if (allCheckbox.checked) {
      button.textContent = 'All Categories';
  } else if (selectedOptions.length === 0) {
      button.textContent = 'Select Categories';
  } else {
      button.textContent = `${selectedOptions.length} Categories selected`;
  }

  button.innerHTML = button.textContent + '<svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z"></path></svg>';
}

// Rendering functions
function renderPerMonthAnalysis() {
    const monthSelect = document.getElementById('monthSelect');
    const pmaTable = document.getElementById('pmaTable');

    const pmaErrorMessage = document.getElementById('pmaErrorMessage');

    if (!monthSelect || !pmaTable) {
        console.error('Required elements for renderPerMonthAnalysis not found.');
        return;
    }

    const selectedAMCs = getSelectedPMAAMCs();
    if (selectedAMCs.length === 0) {
        document.getElementById('pmaTable').style.display = 'none';
        document.getElementById('pmaErrorMessage').style.display = 'flex';
        document.getElementById('pmaErrorTitle').textContent = 'No Account Management Company Selected';
        document.getElementById('pmaerrorDescription').textContent = 'Choose at least one AMC to load data';
        return;
    }

    const monthIndex = parseInt(monthSelect.value);
    if (isNaN(monthIndex)) return;

    const dataType = document.querySelector('input[name="pmaDataType"]:checked').value;
    const table = document.getElementById('pmaTable');
    const thead = table.querySelector('thead tr');
    const tbody = table.querySelector('tbody');

    thead.innerHTML = `
        <th onclick="sortTable('pmaTable', 0)" class="head-main">Stock Name</th>
        <th onclick="sortTable('pmaTable', 1)" class="head-list">Consolidated Change</th>
    `;

    selectedAMCs.forEach((amc, index) => {
        thead.innerHTML += `<th onclick="sortTable('pmaTable', ${index + 2})" class="head-list">${amc}</th>`;
    });

    tbody.innerHTML = '';

    const selectedCategories = getSelectedPMACategories();
    const filteredMasterData = masterData.filter(fund => 
        selectedAMCs.includes(fund['AMC']) && 
        (selectedCategories.includes('all') || selectedCategories.includes(fund['Category']))
    );

    let stocksToShow;
    if (selectedCategories.length === 0) {
        stocksToShow = lastSelectedStocks;
    } else {
        const stocksHeldByAMCs = new Set();
        filteredMasterData.forEach(fund => {
            monthlyData[fund['Fund Name']].forEach(d => {
                if (d['Month'] === months[monthIndex] || d['Month'] === months[monthIndex + 1]) {
                    stocksHeldByAMCs.add(d['ISIN Code']);
                }
            });
        });
        stocksToShow = Array.from(stocksHeldByAMCs);
        lastSelectedStocks = stocksToShow;
    }

    stocksToShow.forEach(stock => {
        const row = tbody.insertRow();
        const stockNameCell = row.insertCell();

        stockNameCell.innerHTML = `${getStockName(stock)}<br><span class="symbol">${getStockSymbol(stock)}</span>`;
        stockNameCell.className = 'sticky-cell';

        let consolidatedChange = 0;
        const consolidatedCell = row.insertCell();

        let isStockHeldByAnyAMC = false;

        selectedAMCs.forEach((amc, index) => {
            const amcFunds = filteredMasterData.filter(fund => fund['AMC'] === amc);
            let month0Value = 0, month1Value = 0;

            amcFunds.forEach(fund => {
                const month0Data = monthlyData[fund['Fund Name']].find(d => d['ISIN Code'] === stock && d['Month'] === months[monthIndex]);
                const month1Data = monthlyData[fund['Fund Name']].find(d => d['ISIN Code'] === stock && d['Month'] === months[monthIndex + 1]);

                if (month0Data && month1Data) {
                    if (dataType === 'Quantity') {
                        month0Value += parseFloat(month0Data['Quantity']) || 0;
                        month1Value += parseFloat(month1Data['Quantity']) || 0;
                    } else if (dataType === 'Market Value') {
                        month0Value += parseFloat(month0Data['Market Value']) || 0;
                        month1Value += parseFloat(month1Data['Market Value']) || 0;
                    } else if (dataType === '% to Nav') {
                        month0Value += parseFloat(month0Data['% to Nav']) || 0;
                        month1Value += parseFloat(month1Data['% to Nav']) || 0;
                    }
                }
            });

            const change = month1Value - month0Value;
            consolidatedChange += change;
            const cellValue = formatIndianNumber(change.toFixed(2));
            row.insertCell().textContent = cellValue;

            if (cellValue !== '0.00') {
                isStockHeldByAnyAMC = true;
            }
        });

        consolidatedCell.textContent = formatIndianNumber(consolidatedChange.toFixed(2));

        if (!isStockHeldByAnyAMC) {
            row.remove();
        }
    });

    if (tbody.children.length === 0) {
        document.getElementById('pmaTable').style.display = 'none';
        document.getElementById('pmaErrorMessage').style.display = 'flex';
        document.getElementById('pmaErrorTitle').textContent = 'No Categories Selected';
        document.getElementById('pmaerrorDescription').textContent = 'Choose at least one category to load data';
    } else {
        document.getElementById('pmaTable').style.display = 'block';
        document.getElementById('pmaErrorMessage').style.display = 'none';
    }
}

function renderMonthOnMonthTable(masterData, monthlyData, selectedAMCs, months) {
    const selectedCategories = getSelectedMOMCategories();
    if (selectedCategories.length === 0) {
        document.getElementById('momTable').style.display = 'none';
        document.getElementById('momErrorMessage').style.display = 'flex';
        document.getElementById('momErrorTitle').textContent = 'No Categories Selected';
        document.getElementById('momErrorDescription').textContent = 'Choose at least one category to load data';
        return;
    }

    const table = document.getElementById('momTable');
    const thead = table.querySelector('thead tr');
    const tbody = table.querySelector('tbody');
    const dataType = document.querySelector('input[name="momDataType"]:checked').value;

    updateErrorMessage(false, 'momTable');

    thead.innerHTML = '<th onclick="sortTable(\'momTable\', 0)" class="head-main">Stock Name</th>';
    months.forEach((month, index) => {
        const date = new Date(month);
        const monthName = date.toLocaleString('default', { month: 'long' });
        const year = date.getFullYear().toString().slice(-2);
        thead.innerHTML += `<th onclick="sortTable('momTable', ${index + 1})" class="head-list">${monthName} ${year} Change</th>`;
    });

    const filteredMasterData = selectedCategories.length > 0 && !selectedCategories.includes('all')
        ? masterData.filter(fund => selectedCategories.includes(fund['Category']))
        : masterData;

    const stocksHeldByAMCs = new Set();
    filteredMasterData.forEach(fund => {
        if (selectedAMCs.includes(fund['AMC'])) {
            monthlyData.filter(d => d['Fund Name'] === fund['Fund Name']).forEach(d => {
                stocksHeldByAMCs.add(d['ISIN Code']);
            });
        }
    });

    const tableData = Array.from(stocksHeldByAMCs).map(stock => {
        const row = [getStockName(stock)];
        let isStockHeldByAnyAMC = false;

        months.forEach((month, monthIndex) => {
            if (monthIndex === 0) {
                row.push('-');
                return;
            }

            let consolidatedChange = 0;
            if (selectedCategories.length > 0) {
                selectedAMCs.forEach(amc => {
                    const amcFunds = filteredMasterData.filter(fund => fund['AMC'] === amc);
                    amcFunds.forEach(fund => {
                        const prevMonthData = monthlyData.find(d => d['ISIN Code'] === stock && d['Month'] === months[monthIndex - 1] && d['Fund Name'] === fund['Fund Name']);
                        const currentMonthData = monthlyData.find(d => d['ISIN Code'] === stock && d['Month'] === month && d['Fund Name'] === fund['Fund Name']);

                        if (prevMonthData && currentMonthData) {
                            let prevValue = 0, currentValue = 0;
                            if (dataType === 'Quantity') {
                                prevValue = parseFloat(prevMonthData['Quantity']) || 0;
                                currentValue = parseFloat(currentMonthData['Quantity']) || 0;
                            } else if (dataType === 'Market Value') {
                                prevValue = parseFloat(prevMonthData['Market Value']) || 0;
                                currentValue = parseFloat(currentMonthData['Market Value']) || 0;
                            } else if (dataType === '% to Nav') {
                                prevValue = parseFloat(prevMonthData['% to Nav']) || 0;
                                currentValue = parseFloat(currentMonthData['% to Nav']) || 0;
                            }
                            consolidatedChange += currentValue - prevValue;
                        }
                    });
                });
            }

            const formattedChange = formatIndianNumber(consolidatedChange.toFixed(2));
            row.push(formattedChange);

            if (formattedChange !== '0.00') {
                isStockHeldByAnyAMC = true;
            }
        });

        return isStockHeldByAnyAMC ? row : null;
    }).filter(row => row !== null);

    tbody.innerHTML = tableData.map(row => `
        <tr>
            ${row.map((cell, index) => `
                <td ${index === 0 ? 'class="sticky-cell"' : ''}>${cell}</td>
            `).join('')}
        </tr>
    `).join('');

    if (tbody.children.length === 0) {
        document.getElementById('momTable').style.display = 'none';
        document.getElementById('momErrorMessage').style.display = 'flex';
        document.getElementById('momErrorTitle').textContent = 'No Account Management Company Selected';
        document.getElementById('momErrorDescription').textContent = 'Choose at least one AMC to load data';
    } else {
        document.getElementById('momTable').style.display = 'table';
        document.getElementById('momErrorMessage').style.display = 'none';
    }
}

// Event handler functions
function handleAllPMAAMCChange(checkbox) {
    const options = document.querySelectorAll('#pmaAMCOptions input[type="checkbox"]');
    options.forEach(option => {
        option.checked = checkbox.checked;
    });
    updatePMAAMCButtonText();
    renderPerMonthAnalysis();
}

function handleAllAMCChange(checkbox) {
    const options = document.querySelectorAll('#momAMCOptions input[type="checkbox"]');
    options.forEach(option => {
        option.checked = checkbox.checked;
    });
    updateAMCButtonText();
    updateTable();
}

function handleAllPMACategoryChange(checkbox) {
    const options = document.querySelectorAll('#pmaCategoryOptions input[type="checkbox"]');
    options.forEach(option => {
        option.checked = checkbox.checked;
    });
    updatePMACategoryButtonText();
    renderPerMonthAnalysis();
}

function handleAllMOMCategoryChange(checkbox) {
    const options = document.querySelectorAll('#momCategoryOptions input[type="checkbox"]');
    options.forEach(option => {
        option.checked = checkbox.checked;
    });
    updateMOMCategoryButtonText();
    updateTable();
}

function handlePMAAMCOptionChange() {
    const allCheckbox = document.querySelector('#pmaAMCDropdown input[value="all"]');
    const options = document.querySelectorAll('#pmaAMCOptions input[type="checkbox"]');
    const allChecked = Array.from(options).every(option => option.checked);
    allCheckbox.checked = allChecked;
    updatePMAAMCButtonText();

    const selectedAMCs = getSelectedPMAAMCs();
    if (selectedAMCs.length === 0) {
        document.getElementById('pmaTable').style.display = 'none';
        document.getElementById('pmaErrorMessage').style.display = 'flex';
        document.getElementById('pmaErrorTitle').textContent = 'No Account Management Company Selected';
        document.getElementById('pmaerrorDescription').textContent = 'Choose at least one AMC to load data';
    } else {
        document.getElementById('pmaTable').style.display = 'table';
        document.getElementById('pmaErrorMessage').style.display = 'none';
        renderPerMonthAnalysis();
    }
}

function handleAMCOptionChange() {
    const allCheckbox = document.querySelector('input[value="all"]');
    const options = document.querySelectorAll('#momAMCOptions input[type="checkbox"]');
    const allChecked = Array.from(options).every(option => option.checked);
    allCheckbox.checked = allChecked;
    updateAMCButtonText();

    const selectedAMCs = getSelectedAMCs();
    if (selectedAMCs.length === 0) {
        document.getElementById('momTable').style.display = 'none';
        document.getElementById('momErrorMessage').style.display = 'flex';
        document.getElementById('momErrorTitle').textContent = 'No Account Management Company Selected';
        document.getElementById('momErrorDescription').textContent = 'Choose at least one AMC to load data';
    } else {
        document.getElementById('momTable').style.display = 'table';
        document.getElementById('momErrorMessage').style.display = 'none';
        updateTable();
    }
}

function handlePMACategoryOptionChange() {
    const allCheckbox = document.querySelector('#pmaCategoryDropdown input[value="all"]');
    const options = document.querySelectorAll('#pmaCategoryOptions input[type="checkbox"]');
    const allChecked = Array.from(options).every(option => option.checked);
    allCheckbox.checked = allChecked;
    updatePMACategoryButtonText();

    const selectedCategories = getSelectedPMACategories();
    if (selectedCategories.length === 0) {
        document.getElementById('pmaTable').style.display = 'none';
        document.getElementById('pmaErrorMessage').style.display = 'flex';
        document.getElementById('pmaErrorTitle').textContent = 'No Categories Selected';
        document.getElementById('pmaerrorDescription').textContent = 'Choose at least one category to load data';
    } else {
        document.getElementById('pmaTable').style.display = 'table';
        document.getElementById('pmaErrorMessage').style.display = 'none';
        renderPerMonthAnalysis();
    }
}

function handleMOMCategoryOptionChange() {
    const allCheckbox = document.querySelector('#momCategoryDropdown input[value="all"]');
    const options = document.querySelectorAll('#momCategoryOptions input[type="checkbox"]');
    const allChecked = Array.from(options).every(option => option.checked);
    allCheckbox.checked = allChecked;
    updateMOMCategoryButtonText();

    const selectedCategories = getSelectedMOMCategories();
    if (selectedCategories.length === 0) {
        document.getElementById('momTable').style.display = 'none';
        document.getElementById('momErrorMessage').style.display = 'flex';
        document.getElementById('momErrorTitle').textContent = 'No Categories Selected';
        document.getElementById('momErrorDescription').textContent = 'Choose at least one category to load data';
    } else {
        document.getElementById('momTable').style.display = 'table';
        document.getElementById('momErrorMessage').style.display = 'none';
        updateTable();
    }
}

// Helper functions
function getSelectedPMAAMCs() {
    const options = document.querySelectorAll('#pmaAMCOptions input[type="checkbox"]:checked');
    return Array.from(options).map(option => option.value);
}

function getSelectedAMCs() {
    const options = document.querySelectorAll('#momAMCOptions input[type="checkbox"]:checked');
    return Array.from(options).map(option => option.value);
}

function getSelectedPMACategories() {
    const allCheckbox = document.querySelector('#pmaCategoryDropdown input[value="all"]');
    if (allCheckbox.checked) {
        return ['all'];
    }
    const options = document.querySelectorAll('#pmaCategoryOptions input[type="checkbox"]:checked');
    return Array.from(options).map(option => option.value);
}

function getSelectedMOMCategories() {
    const allCheckbox = document.querySelector('#momCategoryDropdown input[value="all"]');
    if (allCheckbox.checked) {
        return ['all'];
    }
    const options = document.querySelectorAll('#momCategoryOptions input[type="checkbox"]:checked');
    return Array.from(options).map(option => option.value);
}

function updateTable() {
    const selectedAMCs = getSelectedAMCs();
    renderMonthOnMonthTable(masterData, allMonthlyData, selectedAMCs, months);
}

function showLoading(show) {
    const loadingElement = document.getElementById('loading');
    if (loadingElement) {
        loadingElement.style.display = show ? 'block' : 'none';
    }
}

function sortTable(tableId, n, sortType = 'value') {
    const table = document.getElementById(tableId);
    let rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    switching = true;
    dir = "asc";
    while (switching) {
        switching = false;
        rows = table.rows;
        for (i = 1; i < (rows.length - 1); i++) {
            shouldSwitch = false;
            x = rows[i].getElementsByTagName("TD")[n];
            y = rows[i + 1].getElementsByTagName("TD")[n];

            let xValue, yValue;
            if (n === 0) {
                xValue = x.textContent.toLowerCase();
                yValue = y.textContent.toLowerCase();
            } else if (sortType === 'change' && x.querySelector('span[data-change]')) {
                xValue = parseFloat(x.querySelector('span[data-change]').getAttribute('data-change'));
                yValue = parseFloat(y.querySelector('span[data-change]').getAttribute('data-change'));
            } else {
                xValue = parseFloat(x.textContent.replace(/,/g, ''));
                yValue = parseFloat(y.textContent.replace(/,/g, ''));
            }

            if (dir == "asc") {
                if ((typeof xValue === 'string' && xValue > yValue) ||
                    (typeof xValue === 'number' && xValue > yValue)) {
                    shouldSwitch = true;
                    break;
                }
            } else if (dir == "desc") {
                if ((typeof xValue === 'string' && xValue < yValue) ||
                    (typeof xValue === 'number' && xValue < yValue)) {
                    shouldSwitch = true;
                    break;
                }
            }
        }
        if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchcount++;
        } else {
            if (switchcount == 0 && dir == "asc") {
                dir = "desc";
                switching = true;
            }
        }
    }
}

function showTab(tabId) {
    document.querySelectorAll('.list-div').forEach(div => {
        div.style.display = 'none';
    });
    document.querySelectorAll('.tab-item').forEach(item => {
        item.classList.remove('active');
    });
    document.getElementById(tabId).style.display = 'block';
    document.querySelector(`.tab-item[onclick="showTab('${tabId}')"]`).classList.add('active');
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
    fetchData();
    fetchMonthOnMonthData();
    
    const tabItems = document.querySelectorAll('.tab-item');
    tabItems.forEach(item => {
        item.addEventListener('click', (event) => {
            const tabId = event.target.getAttribute('onclick').match(/'([^']+)'/)[1];
            showTab(tabId);
        });
    });

    document.querySelectorAll('input[name="pmaDataType"]').forEach(radio => {
        radio.addEventListener('change', renderPerMonthAnalysis);
    });

    document.querySelectorAll('input[name="momDataType"]').forEach(radio => {
        radio.addEventListener('change', updateTable);
    });

    document.getElementById('pmaCategoryOptions').addEventListener('change', handlePMACategoryOptionChange);
    document.getElementById('pmaAMCOptions').addEventListener('change', handlePMAAMCOptionChange);
    document.getElementById('momAMCOptions').addEventListener('change', handleAMCOptionChange);

    document.addEventListener('click', closeDropdowns);


    const allMOMCategoriesCheckbox = document.querySelector('#momCategoryDropdown input[value="all"]');
    if (allMOMCategoriesCheckbox) {
        allMOMCategoriesCheckbox.addEventListener('change', (event) => handleAllMOMCategoryChange(event.target));
    }

    const momCategoryOptions = document.querySelectorAll('#momCategoryOptions input[type="checkbox"]');
    momCategoryOptions.forEach(option => {
        option.addEventListener('change', handleMOMCategoryOptionChange);
    });

    const allPMACategoriesCheckbox = document.querySelector('#pmaCategoryDropdown input[value="all"]');
    if (allPMACategoriesCheckbox) {
        allPMACategoriesCheckbox.addEventListener('change', (event) => handleAllPMACategoryChange(event.target));
    }

    const pmaCategoryOptions = document.querySelectorAll('#pmaCategoryOptions input[type="checkbox"]');
    pmaCategoryOptions.forEach(option => {
        option.addEventListener('change', handlePMACategoryOptionChange);
    });

    showTab('perMonthAnalysis');
});

// Initialize
fetchData();

function togglePMAAMCDropdown(event) {
    event.preventDefault();
    const dropdown = document.getElementById('pmaAMCDropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function togglePMACategoryDropdown(event) {
    event.preventDefault();
    const dropdown = document.getElementById('pmaCategoryDropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function toggleAMCDropdown(event) {
    event.preventDefault();
    const dropdown = document.getElementById('momAMCDropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function toggleMOMCategoryDropdown(event) {
    event.preventDefault();
    const dropdown = document.getElementById('momCategoryDropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function updateErrorMessage(show, tableId) {
    const errorMessage = document.querySelector(`#${tableId} + .error-msg`);
    if (errorMessage) {
        errorMessage.style.display = show ? 'flex' : 'none';
    }
}

function closeDropdowns(event) {
    const dropdowns = [
        { button: 'pmaAMCButton', dropdown: 'pmaAMCDropdown' },
        { button: 'pmaCategoryButton', dropdown: 'pmaCategoryDropdown' },
        { button: 'momAMCButton', dropdown: 'momAMCDropdown' },
        { button: 'momCategoryButton', dropdown: 'momCategoryDropdown' }
    ];

    dropdowns.forEach(({ button, dropdown }) => {
        const buttonElement = document.getElementById(button);
        const dropdownElement = document.getElementById(dropdown);
        if (dropdownElement && buttonElement && !buttonElement.contains(event.target) && !dropdownElement.contains(event.target)) {
            dropdownElement.style.display = 'none';
        }
    });
}
    </script>
</body>

</html>